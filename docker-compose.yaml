services:
  tests:
    image: postman/newman
    volumes:
      - ./tests/:/etc/newman/
      - ./reports:/etc/newman/reports
    command: 
      run
      /etc/newman/api_testing.json
      -r cli,junit
    networks:
      - local_net
    depends_on:
      api:
        condition: service_healthy
  api:
    build:
      context: ./
      dockerfile: Dockerfile
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "8001:8001"
    # expose:
    #   - 8001
    networks:
      - local_net
    env_file: .env
    command: 
    - --default-authentication-plugin=mysql_native_password
    - --initialize-insecure
    restart: unless-stopped
    healthcheck:
      test: netstat -ltn | grep :8001

  db:
    image: mysql:8
    env_file: .env
    ports:
      - 3306:3306
    networks:
      - local_net
    volumes:
      - mysql_data:/var/lib/mysql_data
    healthcheck:
      test: ['CMD-SHELL', 'mysqladmin ping -h 127.0.0.1 --password="$$(cat /run/secrets/db-password)" --silent']
      interval: 10s
      timeout: 3s
      retries: 1
    restart: unless-stopped


networks:
  local_net:
    driver: bridge

volumes:
  pg_data:
  mysql_data:

secrets:
  db-password:
   file: .secrets